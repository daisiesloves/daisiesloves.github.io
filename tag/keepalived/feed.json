{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo • All posts by \"keepalived\" tag",
    "description": null,
    "home_page_url": "http://yoursite.com",
    "items": [
        {
            "id": "http://yoursite.com/2018/12/25/Keepalived%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8Nginx%E6%9C%8D%E5%8A%A1/",
            "url": "http://yoursite.com/2018/12/25/Keepalived%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8Nginx%E6%9C%8D%E5%8A%A1/",
            "title": "Keepalived实现高可用Nginx服务",
            "date_published": "2018-12-25T04:15:15.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><p>测试环境:</p>\n<pre><code>websrvs:realsrv1: 192.168.6.80, realsrv2: 192.168.6.82\nkeepsrvs:nodesrv1: 192.168.6.86, nodesrv2: 192.168.6.88\ncleint: 192.168.6.68\nvip: 192.168.6.99\n</code></pre>\n<p>实验目的:</p>\n<pre><code>当主节点nodesrv1上反向代理服务nginx异常不可用,主节点自身调度优先级别降低并释放vip转移给节点nodesrv2\n</code></pre>\n<p>1. 在 2 台节点服务器分别安装 nginx</p>\n<pre><code>nodesrv[1,2]\n\t~# yum install psmisc -y #'killall'命令程序包\n\tyum install nginx -y\n\tsystemctl start nginx\n\tsystemctl enable nginx\n\n(1)编辑nginx配置文件,实现代理\n\tvi /etc/nginx/conf.d/www.conf\n\tupstream websrvs &#123;\n\t\tserver 192.168.6.80:80;\n\t\tserver 192.168.6.82:80;\n\t&#125;\n\n\tserver &#123;\n\t\tlisten 80 default_server;\n\t\tserver_name nodesrv1.lboy.com;\n\t\troot /usr/share/nginx/html;\n\t\tlocation /&#123;\n\t\t\tproxy_pass http://websrvs;\n\t\t&#125;\n\t&#125;\n\n(2)编辑nginx主配置文件,删除默认server\n\tvi /etc/nginx/nginx.conf\n\t\tserver &#123;\n\t\t\tlisten       80;\n\t\t\tserver_name  localhost;\n\t\t\t...\n\t&#125;\n\n(3)在nodesrv2上同样配置nginx\n\tscp /etc/nginx/conf.d/www.conf root@192.168.6.88:/etc/nginx/conf.d/www.conf\n\tvi /etc/nginx/conf.d/www.conf\n\tserver_name nodesrv2.lboy.com;\n\t...\n</code></pre>\n<p>2. 修改 keepalived 配置文件示例如下<br>\n～# systemctl stop keepalived</p>\n<pre><code>#nodesrv1配置文件\n~# man 5 keepalived.conf\nvi /etc/keepalived/keepalived.cfg\n! Configuration File for keepalived\n\nglobal_defs &#123;\n\tnotification_email &#123;\n\t\troot@localhost\n&#125;\n\tnotification_email_from keepalived@localhost\n\tsmtp_server 127.0.0.1\n\tsmtp_connect_timeout 30\n\trouter_id nodesrv1\n\tvrrp_mcast_group4 224.0.100.89\n\tvrrp_skip_check_adv_addr\n\tvrrp_strict\n\tvrrp_garp_interval 0\n\tvrrp_gna_interval 0\n\tvrrp_iptables #不添加iptables规则\n&#125;\n\nvrrp_script chk_nginx &#123;\n\tscript &quot;killall -0 nginx &amp;&amp; exit 0 || exit 1&quot;\n\tinterval 1 #检测时间间隔\n\tweight -5  #权重降级\n\tfall 2\n\trise 1\n&#125;\n\nvrrp_instance VI_1 &#123;\n\tstate MASTER\n\tinterface ens33\n\tvirtual_router_id 16\n\tpriority 100\n\tadvert_int 1\n\tauthentication &#123;\n\t\tauth_type PASS\n\t\tauth_pass 516f97b2\n\t&#125;\n\tvirtual_ipaddress &#123;\n\t192.168.6.99/24 dev ens33\n\t&#125;\n\ttrack_interface &#123;\n\t\tens33\n\t&#125;\n\n\ttrack_script &#123;\n\t\tchk_nginx #调用脚本名称,与上定义的脚本名称相同\n\t&#125;\n\tnotify_master &quot;/etc/keepalived/notify.sh master&quot;\n\tnotify_backup &quot;/etc/keepalived/notify.sh backup&quot; #nginx异常终止时,主节点降为从节点,并传递参数执行脚本,尝试启动nginx\n\tnotify_fault &quot;/etc/keepalived/notify.sh fault&quot;\n&#125;\n\n#vrrp_instance VI_2 &#123;\n#\tstate MASTER\n#\tinterface ens33\n#\tvirtual_router_id 26\n#\tpriority 98\n#\tadvert_int 1\n#\tauthentication &#123;\n#\t\tauth_type PASS\n#\t\tauth_pass 0uuOpPPp\n#\t&#125;\n#\tvirtual_ipaddress &#123;\n#\t\t192.168.6.98/24 dev ens33\n#\t&#125;\n#&#125;\n\n#nodesrv2配置文件\n\nvi /etc/keepalived/keepalived.cfg\n...\nvrrp_instance VI_1 &#123;\n\tstate BACKUP\n\tinterface ens33\n\tvirtual_router_id 16\n\tpriority 98\n\tadvert_int 1\n\tauthentication &#123;\n\t\tauth_type PASS\n\t\tauth_pass 516f97b2\n\t&#125;\n\tvirtual_ipaddress &#123;\n\t\t192.168.6.99/24 dev ens33\n\t&#125;\n\ttrack_interface &#123;\n\t\tens33\n\t&#125;\n\ttrack_script &#123;\n\t\tchk_nginx\n\t&#125;\n\tnotify_master &quot;/etc/keepalived/notify.sh master&quot;\n\tnotify_backup &quot;/etc/keepalived/notify.sh backup&quot;\n\tnotify_fault &quot;/etc/keepalived/notify.sh fault&quot;\n&#125;\n\n#vrrp_instance VI_2 &#123;\n#\tstate MASTER\n#\tinterface ens33\n#\tvirtual_router_id 26\n#\tpriority 100\n#\tadvert_int 1\n#\tauthentication &#123;\n#\t\tauth_type PASS\n#\t\tauth_pass 0uuOpPPp\n#\t&#125;\n#\tvirtual_ipaddress &#123;\n#\t\t192.168.6.98/24 dev ens33\n#\t&#125;\n#&#125;\n</code></pre>\n<p>3. 启动服务测试<br>\n systemctl start keepalived<br>\nsystemctl status keepalived</p>\n<pre><code>cleint访问测试\n~# while true; do curl 192.168.6.99; sleep 1; done\n</code></pre>\n<p>#停止 nodesrv1 上的 nginx 服务，在 nodesrv2 上抓包观察 VIP 地址流动</p>\n<pre><code>nodesrv1\n~# systemctl sotp nginx\n\nnodesrv2\n~# tcpdump -i ens33 -nn host 224.0.100.89\n</code></pre>\n<p>#调适 keepalived 脚本</p>\n<pre><code>注意:\n\tvrrp_script chk_ndown &#123;\n\t\tscript &quot;/bin/bash -c '[[ -f /etc/keepalived/down ]]' &amp;&amp; exit 1 || exit 0&quot; #'/etc/keepalived/down',文件存在时,权重降级\n\t\tinterval 1\n\t\tweight -10\n\t&#125;\n\n\t#[[ -f /etc/keepalived/down ]],要特别地作为bash的参数的运行\n\n\ttrack_script &#123;\n\t\t#chk_nginx\n\t\tchk_ndown\n\t&#125;</code></pre>\n",
            "tags": [
                "keepalived"
            ]
        },
        {
            "id": "http://yoursite.com/2018/12/24/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8IPVS%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%E6%A3%80%E6%B5%8B/",
            "url": "http://yoursite.com/2018/12/24/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8IPVS%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%E6%A3%80%E6%B5%8B/",
            "title": "Keepalived高可用IPVS健康状态检测",
            "date_published": "2018-12-24T13:16:39.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><p>测试环境</p>\n<pre><code>nodesrv1: 192.168.6.86, nodesrv2: 192.168.6.88\nrealsrv1: 192.168.6.80, realsrv2: 192.168.6.82\ncleint: 192.168.6.68\nvip: 192.168.6.99\n</code></pre>\n<p>1.nodesrv 端安装及配置</p>\n<pre><code>nodesrv[1,2]\n\tyum install keepalived -y\n\tyum install ipvsadm -y\n</code></pre>\n<p>2.nodesrv1 配置文件，nodesrv2 修改对应 IP 地址</p>\n<pre><code>vi /etc/keepalived/keepalived.conf\n! Configuration File for keepalived\n\nglobal_defs &#123;\n\tnotification_email &#123;\n\troot@localhost\n\t&#125;\n\tnotification_email_from keepalived@localhost\n\tsmtp_server 127.0.0.1\n\tsmtp_connect_timeout 30\n\trouter_id nodesrv1\n\tvrrp_mcast_group4 224.0.100.89\n\tvrrp_skip_check_adv_addr\n\tvrrp_strict\n\tvrrp_garp_interval 0\n\tvrrp_gna_interval 0\n&#125;\n\nvrrp_instance VI_1 &#123;\n\tstate MASTER\n\tinterface ens33\n\tvirtual_router_id 16\n\tpriority 100\n\tadvert_int 1\n\tauthentication &#123;\n\t\tauth_type PASS\n\t\tauth_pass 516f97b2\n\t&#125;\n\tvirtual_ipaddress &#123;\n\t192.168.6.99/24 dev ens33\n\t&#125;\n\ttrack_interface &#123;\n\tens33\n\t&#125;\n\tnotify_master &quot;/etc/keepalived/notify.sh master&quot;\n\tnotify_backup &quot;/etc/keepalived/notify.sh backup&quot;\n\tnotify_fault &quot;/etc/keepalived/notify.sh fault&quot;   \n&#125;\n\nvrrp_instance VI_2 &#123;\n\tstate BACKUP\n\tinterface ens33\n\tvirtual_router_id 26\n\tpriority 98\n\tadvert_int 1\n\tauthentication &#123;\n\t\tauth_type PASS\n\t\tauth_pass 0uuOpPPp\n\t&#125;\n\tvirtual_ipaddress &#123;\n\t\t192.168.6.98/24 dev ens33\n\t&#125;\n&#125;\n\nvirtual_server 192.168.6.99 80 &#123;\n\tdelay_loop 2\n\tlb_algo rr\n\tlb_kind DR\n\t# persistence_timeout 50\n\tprotocol TCP\n\n\tsorry_server 127.0.0.1 80 #定义sorry-server\n\n\treal_server 192.168.6.80 80 &#123;\n\t\tweight 1\n\t\tHTTP_GET &#123;\n\t\t\turl &#123;\n\t\t\tpath /\n\t\t\tstatus_code 200\n\t\t\t&#125;\n\t\t\tconnect_timeout 2\t #连接超时时长\n\t\t\tnb_get_retry 3\t\t #超时重试数次\n\t\t\tdelay_before_retry 1 #每次重试时间间隔\n\t\t&#125;\n\t&#125;\n\treal_server 192.168.6.82 80 &#123;\n\t\tweight 1\n\t\tHTTP_GET &#123;\n\t\t\turl &#123;\n\t\t\tpath /\n\t\t\tstatus_code 200\n\t\t\t&#125;\n\t\t\tconnect_timeout 2\n\t\t\tnb_get_retry 3\n\t\t\tdelay_before_retry 1\n\t\t&#125;\n\t&#125;\n&#125;\n</code></pre>\n<p>3.realsrv [1,2] 运行配置脚本<br>\n～# sh lvs_dr_rs.sh start</p>\n<pre><code>vi lvs_dr_rs.sh\n#!/bin/bash\n#Author:wangxiaochun\n#Date:2017-08-13\nvip=192.168.6.99\nmask='255.255.255.255'\ndev=lo:1\nrpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null\nservice httpd start &amp;&gt; /dev/null &amp;&amp; echo &quot;The httpd Server is Ready!&quot;\necho &quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot; &gt; /var/www/html/index.html\n\ncase $1 in\nstart)\n\techo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore\n\techo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore\n\techo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce\n\techo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce\n\tifconfig $dev $vip netmask $mask #broadcast $vip up\n\t#route add -host $vip dev $dev\n\techo &quot;The RS Server is Ready!&quot;\n\t;;\nstop)\n\tifconfig $dev down\n\techo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore\n\techo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore\n\techo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce\n\techo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce\n\techo &quot;The RS Server is Canceled!&quot;\n\t;;\n*) \n\techo &quot;Usage: $(basename $0) start|stop&quot;\n\texit 1\n\t;;\nesac\n</code></pre>\n<p>4. 配置 sorry-server</p>\n<pre><code>nodesrv[1,2]\n\tyum install httpd -y\n\techo 'sorry server nodesrv[1,2]' &gt;/www/html/index.html\n\tsystemctl start httpd\n</code></pre>\n<p>5.cleint 测试集群环境，注意防火墙规则</p>\n<pre><code>~# while true; do curl 192.168.6.99; sleep 1; done\n</code></pre>\n",
            "tags": [
                "keepalived"
            ]
        }
    ]
}