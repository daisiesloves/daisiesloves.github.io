{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo • All posts by \"tomcat\" tag",
    "description": null,
    "home_page_url": "http://yoursite.com",
    "items": [
        {
            "id": "http://yoursite.com/2019/01/05/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86Tomcat%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-redis%E5%AE%9E%E7%8E%B0session%E5%85%B1%E4%BA%AB/",
            "url": "http://yoursite.com/2019/01/05/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86Tomcat%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-redis%E5%AE%9E%E7%8E%B0session%E5%85%B1%E4%BA%AB/",
            "title": "Nginx反向代理Tomcat负载均衡+redis实现session共享",
            "date_published": "2019-01-05T04:19:50.000Z",
            "content_html": "<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><p>测试环境</p>\n<pre><code>tomcatsrvs:node01srv: 192.168.6.80, node02srv: 192.168.6.82\nmastersrv:nginxsrv: 192.168.6.88\nredisrv: 192.168.6.86\n\ncat /etc/hosts\n192.168.6.80 node01.lboy.com\n192.168.6.82 node02.lboy.com\n192.168.6.86 node06.lboy.com\n192.168.6.88 master.lboy.com, www.lboy.com\n</code></pre>\n<p>1. 安装配置前端 nginxsrv</p>\n<pre><code>(1)修改nginx主配置文件\nyum install nginx -y\nvi /etc/nginx/nginx.conf #删除主配置文件默认的虚拟主机\nlisten 80;\n\n#测试代理\n\tvi /etc/nginx/conf.d/www.conf\n\tserver &#123;\n\t\tlisten 80 default_server;\n\t\tserver_name www.lboy.com;\n\t\tlocation / &#123;\n\t\t\tproxy_pass http://192.168.6.80:8080; #使用IP地址,访问默认的tomcat虚拟主机;当有多个虚拟主机时,应使用域名解析\n\t\t\t#proxy_pass http://node01.lboy.com:8080; #&quot;node01.lboy.com&quot;确保主机名正常解析\n\t\t&#125;\n\t&#125;\n\n\tsystemctl start nginx\n\n\thttp://www.lboy.com/ #浏览器测试正常访问tomcat默认虚拟主机\n\tTomcatA.magedu.com\n\tSession ID \tC83F0DB65F70CFDBDE0EEC8EB0B376CE\n\tCreated on \t1531556340022\n\n(2)添加nginx代理配置\nvi /etc/nginx/conf.d/www.conf\nupstream tcsrvs &#123;\n\t#ip_hash; #'ip_hash'会话绑定实现负载均衡,此方法粗糙建议使用cookie会话绑定\n\tserver node01.lboy.com:8080;\n\tserver node02.lboy.com:8080;\n&#125;\n\nserver &#123;\n\tlisten 80 default_server;\n\tserver_name www.lboy.com;\n\tlocation / &#123;\n\t\tproxy_pass http://tcsrvs;\n\t&#125;\n&#125;\n\n注意:nginx反向代理后端tomcat服务器时,域名已经解析成IP地址;访问tomcat时,是通过IP地址进行访问,所以会访问到tomcat的默认虚拟主机,需要修改默认虚拟主机配置\n</code></pre>\n<p>2. 后端 tomcatsrvs 节点，node01srv&amp;node02srv 安装配置</p>\n<pre><code>(1)node01srv\nyum install java-1.8.0-openjdk-devel\nyum install tomcat tomcat-lib tomcat-admin-webapps tomcat-webapps\n\nmkdir -pv /data/webapps/ROOT/&#123;classes,lib,META-INF,WEB-INF&#125;\nvi /data/webapps/ROOT/index.jsp\n&lt;%@ page language=&quot;java&quot; %&gt;\t\t\t\n&lt;html&gt;\n\t&lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;\n\t&lt;body&gt;\n\t\t&lt;h1&gt;&lt;font color=&quot;red&quot;&gt;TomcatA.magedu.com&lt;/font&gt;&lt;/h1&gt;\n\t\t&lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;\t\n\t\t\t&lt;tr&gt;\n\t\t\t\t&lt;td&gt;Session ID&lt;/td&gt;\n\t\t\t&lt;% session.setAttribute(&quot;magedu.com&quot;,&quot;magedu.com&quot;); %&gt;\n\t\t\t\t&lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;\n\t\t\t&lt;/tr&gt;\n\t\t\t&lt;tr&gt;\n\t\t\t\t&lt;td&gt;Created on&lt;/td&gt;\n\t\t\t\t&lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;\n\t\t\t&lt;/tr&gt;\n\t\t&lt;/table&gt;\n\t&lt;/body&gt;\n&lt;/html&gt;\n\ncp /etc/tomcat/server.xml&#123;,.bak&#125;\nvi /etc/tomcat/server.xml\n&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;node01.lboy.com&quot;&gt; #修改默认虚拟主机\n\n&lt;Host name=&quot;node01.lboy.com&quot; appBase=&quot;/data/webapps&quot; unpackWAR=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;\n\t&lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;\n\t\tprefix=&quot;node01_access_log.&quot; suffix=&quot;.log&quot;\n\t\tpattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;\n&lt;/Host&gt;\n\n(2)node02srv\nyum install java-1.8.0-openjdk-devel\nyum install tomcat tomcat-lib tomcat-admin-webapps tomcat-webapps\nscp -rp 192.168.6.80:/data/ /\n\n~#vi /data/webapps/ROOT/index.jsp\n&lt;%@ page language=&quot;java&quot; %&gt;\n&lt;html&gt;\n\t&lt;head&gt;&lt;title&gt;TomcatB&lt;/title&gt;&lt;/head&gt;\n\t&lt;body&gt;\n\t\t&lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;TomcatB.magedu.com&lt;/font&gt;&lt;/h1&gt;\n\t\t&lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;\n\t\t\t\t&lt;tr&gt;\n\t\t\t\t\t&lt;td&gt;Session ID&lt;/td&gt;\n\t\t\t\t&lt;% session.setAttribute(&quot;magedu.com&quot;,&quot;magedu.com&quot;); %&gt;\n\t\t\t\t\t&lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;\n\t\t\t\t&lt;/tr&gt;\n\t\t\t\t&lt;tr&gt;\n\t\t\t\t\t&lt;td&gt;Created on&lt;/td&gt;\n\t\t\t\t\t&lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;\n\t\t\t\t&lt;/tr&gt;\n\t\t&lt;/table&gt;\n\t&lt;/body&gt;\n&lt;/html&gt;\n\nscp 192.168.6.80:/etc/tomcat/&#123;server.xml,tomcat-users.xml&#125; /etc/tomcat/\nvi /etc/tomcat/server.xml\n&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;node02.lboy.com&quot;&gt; #修改默认虚拟主机\n\n&lt;Host name=&quot;node02.lboy.com&quot; appBase=&quot;/data/webapps&quot; unpackWAR=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;\n\t&lt;Context path=&quot;/appt&quot; docBase=&quot;/data/otherapps/myapp&quot; reloadable=&quot;&quot;/&gt;\n\t&lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;\n\t\t   prefix=&quot;node01_access_log.&quot; suffix=&quot;.log&quot;\n\t\t   pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;\n&lt;/Host&gt;\n\nsystemctl start tomcat\n</code></pre>\n<p>3. 安装配置 redisrv 实现 session 共享</p>\n<pre><code>(1)安装配置redisrv\nyum -y install redis\t\ncp /etc/redis.conf&#123;,.bak&#125;\nvi /etc/redis.conf\n#bind 127.0.0.1 #redis默认只允许本地访问,注释bind 127.0.0.1允许所有的IP访问redis\nbind 192.168.6.80 192.168.6.82 #指定可以访问的IP\n#protected-mode yes #在redis3.2之后,redis增加了protected-mode,在这个模式下,即使注释掉了bind 127.0.0.1,再访问redisd时候还是报错\nprotected-mode no\ndaemonize yes\n#daemonize no\n\n(2)拷贝以下三个jar文件至各tomcat节点类库文件目录/usr/share/tomcat/lib -&gt; /usr/share/java/tomcat\n~# tree tomcat8-redis-session-manager\ntomcat8-redis-session-manager/\n├── commons-pool2-2.2.jar\n├── jedis-2.5.2.jar\n└── tomcat-redis-session-manager-2.0.0.jar\n\n(3)编辑各tomcat节点context.xml文件,添加以下内容配置redis服务\nvi /etc/tomcat/context.xml\n&lt;Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot; /&gt;       \n&lt;Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;\nhost=&quot;192.168.6.86&quot; #redisrv,IP地址\nport=&quot;6379&quot;\ndatabase=&quot;0&quot;\nmaxInactiveInterval=&quot;60&quot;/&gt;\n\n启动redis服务,重新启动所有tomcat,启动nginx,刷新nginx页面,两台tomcat页面可以看到sessionid值不变,关闭某台tomcat,nginx中sessionid不变,说明session是共享的.\n\n参考博文\n\thttps://www.cnblogs.com/mrlinfeng/p/6146866.html\n</code></pre>\n",
            "tags": [
                "tomcat"
            ]
        }
    ]
}