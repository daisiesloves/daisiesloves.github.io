<?xml version="1.0"?>
<rss version="2.0">
    <channel>
        <title>It&#39;s better to burn out than to fade away. • Posts by &#34;tomcat&#34; tag</title>
        <link>http://yoursite.com</link>
        <description></description>
        <language></language>
        <pubDate>Sat, 05 Jan 2019 12:19:50 +0800</pubDate>
        <lastBuildDate>Sat, 05 Jan 2019 12:19:50 +0800</lastBuildDate>
        <category>Test</category>
        <category>httpd</category>
        <category>keepalived</category>
        <category>markdown</category>
        <category>tomcat</category>
        <category>Flume JDK</category>
        <item>
            <guid isPermalink="true">http://yoursite.com/2019/01/05/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86Tomcat%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-redis%E5%AE%9E%E7%8E%B0session%E5%85%B1%E4%BA%AB/</guid>
            <title>Nginx反向代理Tomcat负载均衡+redis实现session共享</title>
            <link>http://yoursite.com/2019/01/05/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86Tomcat%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-redis%E5%AE%9E%E7%8E%B0session%E5%85%B1%E4%BA%AB/</link>
            <category>tomcat</category>
            <pubDate>Sat, 05 Jan 2019 12:19:50 +0800</pubDate>
            <description><![CDATA[ &lt;link rel=&#34;stylesheet&#34; class=&#34;aplayer-secondary-style-marker&#34; href=&#34;\assets\css\APlayer.min.css&#34;&gt;&lt;script src=&#34;\assets\js\APlayer.min.js&#34; class=&#34;aplayer-secondary-script-marker&#34;&gt;&lt;/script&gt;&lt;p&gt;测试环境&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;tomcatsrvs:node01srv: 192.168.6.80, node02srv: 192.168.6.82
mastersrv:nginxsrv: 192.168.6.88
redisrv: 192.168.6.86

cat /etc/hosts
192.168.6.80 node01.lboy.com
192.168.6.82 node02.lboy.com
192.168.6.86 node06.lboy.com
192.168.6.88 master.lboy.com, www.lboy.com
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;1. 安装配置前端 nginxsrv&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;(1)修改nginx主配置文件
yum install nginx -y
vi /etc/nginx/nginx.conf #删除主配置文件默认的虚拟主机
listen 80;

#测试代理
	vi /etc/nginx/conf.d/www.conf
	server &amp;#123;
		listen 80 default_server;
		server_name www.lboy.com;
		location / &amp;#123;
			proxy_pass http://192.168.6.80:8080; #使用IP地址,访问默认的tomcat虚拟主机;当有多个虚拟主机时,应使用域名解析
			#proxy_pass http://node01.lboy.com:8080; #&amp;quot;node01.lboy.com&amp;quot;确保主机名正常解析
		&amp;#125;
	&amp;#125;

	systemctl start nginx

	http://www.lboy.com/ #浏览器测试正常访问tomcat默认虚拟主机
	TomcatA.magedu.com
	Session ID 	C83F0DB65F70CFDBDE0EEC8EB0B376CE
	Created on 	1531556340022

(2)添加nginx代理配置
vi /etc/nginx/conf.d/www.conf
upstream tcsrvs &amp;#123;
	#ip_hash; #&#39;ip_hash&#39;会话绑定实现负载均衡,此方法粗糙建议使用cookie会话绑定
	server node01.lboy.com:8080;
	server node02.lboy.com:8080;
&amp;#125;

server &amp;#123;
	listen 80 default_server;
	server_name www.lboy.com;
	location / &amp;#123;
		proxy_pass http://tcsrvs;
	&amp;#125;
&amp;#125;

注意:nginx反向代理后端tomcat服务器时,域名已经解析成IP地址;访问tomcat时,是通过IP地址进行访问,所以会访问到tomcat的默认虚拟主机,需要修改默认虚拟主机配置
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;2. 后端 tomcatsrvs 节点，node01srv&amp;amp;node02srv 安装配置&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;(1)node01srv
yum install java-1.8.0-openjdk-devel
yum install tomcat tomcat-lib tomcat-admin-webapps tomcat-webapps

mkdir -pv /data/webapps/ROOT/&amp;#123;classes,lib,META-INF,WEB-INF&amp;#125;
vi /data/webapps/ROOT/index.jsp
&amp;lt;%@ page language=&amp;quot;java&amp;quot; %&amp;gt;			
&amp;lt;html&amp;gt;
	&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;TomcatA&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
	&amp;lt;body&amp;gt;
		&amp;lt;h1&amp;gt;&amp;lt;font color=&amp;quot;red&amp;quot;&amp;gt;TomcatA.magedu.com&amp;lt;/font&amp;gt;&amp;lt;/h1&amp;gt;
		&amp;lt;table align=&amp;quot;centre&amp;quot; border=&amp;quot;1&amp;quot;&amp;gt;	
			&amp;lt;tr&amp;gt;
				&amp;lt;td&amp;gt;Session ID&amp;lt;/td&amp;gt;
			&amp;lt;% session.setAttribute(&amp;quot;magedu.com&amp;quot;,&amp;quot;magedu.com&amp;quot;); %&amp;gt;
				&amp;lt;td&amp;gt;&amp;lt;%= session.getId() %&amp;gt;&amp;lt;/td&amp;gt;
			&amp;lt;/tr&amp;gt;
			&amp;lt;tr&amp;gt;
				&amp;lt;td&amp;gt;Created on&amp;lt;/td&amp;gt;
				&amp;lt;td&amp;gt;&amp;lt;%= session.getCreationTime() %&amp;gt;&amp;lt;/td&amp;gt;
			&amp;lt;/tr&amp;gt;
		&amp;lt;/table&amp;gt;
	&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;

cp /etc/tomcat/server.xml&amp;#123;,.bak&amp;#125;
vi /etc/tomcat/server.xml
&amp;lt;Engine name=&amp;quot;Catalina&amp;quot; defaultHost=&amp;quot;node01.lboy.com&amp;quot;&amp;gt; #修改默认虚拟主机

&amp;lt;Host name=&amp;quot;node01.lboy.com&amp;quot; appBase=&amp;quot;/data/webapps&amp;quot; unpackWAR=&amp;quot;true&amp;quot; autoDeploy=&amp;quot;true&amp;quot;&amp;gt;
	&amp;lt;Valve className=&amp;quot;org.apache.catalina.valves.AccessLogValve&amp;quot; directory=&amp;quot;logs&amp;quot;
		prefix=&amp;quot;node01_access_log.&amp;quot; suffix=&amp;quot;.log&amp;quot;
		pattern=&amp;quot;%h %l %u %t &amp;amp;quot;%r&amp;amp;quot; %s %b&amp;quot; /&amp;gt;
&amp;lt;/Host&amp;gt;

(2)node02srv
yum install java-1.8.0-openjdk-devel
yum install tomcat tomcat-lib tomcat-admin-webapps tomcat-webapps
scp -rp 192.168.6.80:/data/ /

~#vi /data/webapps/ROOT/index.jsp
&amp;lt;%@ page language=&amp;quot;java&amp;quot; %&amp;gt;
&amp;lt;html&amp;gt;
	&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;TomcatB&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;
	&amp;lt;body&amp;gt;
		&amp;lt;h1&amp;gt;&amp;lt;font color=&amp;quot;blue&amp;quot;&amp;gt;TomcatB.magedu.com&amp;lt;/font&amp;gt;&amp;lt;/h1&amp;gt;
		&amp;lt;table align=&amp;quot;centre&amp;quot; border=&amp;quot;1&amp;quot;&amp;gt;
				&amp;lt;tr&amp;gt;
					&amp;lt;td&amp;gt;Session ID&amp;lt;/td&amp;gt;
				&amp;lt;% session.setAttribute(&amp;quot;magedu.com&amp;quot;,&amp;quot;magedu.com&amp;quot;); %&amp;gt;
					&amp;lt;td&amp;gt;&amp;lt;%= session.getId() %&amp;gt;&amp;lt;/td&amp;gt;
				&amp;lt;/tr&amp;gt;
				&amp;lt;tr&amp;gt;
					&amp;lt;td&amp;gt;Created on&amp;lt;/td&amp;gt;
					&amp;lt;td&amp;gt;&amp;lt;%= session.getCreationTime() %&amp;gt;&amp;lt;/td&amp;gt;
				&amp;lt;/tr&amp;gt;
		&amp;lt;/table&amp;gt;
	&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;

scp 192.168.6.80:/etc/tomcat/&amp;#123;server.xml,tomcat-users.xml&amp;#125; /etc/tomcat/
vi /etc/tomcat/server.xml
&amp;lt;Engine name=&amp;quot;Catalina&amp;quot; defaultHost=&amp;quot;node02.lboy.com&amp;quot;&amp;gt; #修改默认虚拟主机

&amp;lt;Host name=&amp;quot;node02.lboy.com&amp;quot; appBase=&amp;quot;/data/webapps&amp;quot; unpackWAR=&amp;quot;true&amp;quot; autoDeploy=&amp;quot;true&amp;quot;&amp;gt;
	&amp;lt;Context path=&amp;quot;/appt&amp;quot; docBase=&amp;quot;/data/otherapps/myapp&amp;quot; reloadable=&amp;quot;&amp;quot;/&amp;gt;
	&amp;lt;Valve className=&amp;quot;org.apache.catalina.valves.AccessLogValve&amp;quot; directory=&amp;quot;logs&amp;quot;
		   prefix=&amp;quot;node01_access_log.&amp;quot; suffix=&amp;quot;.log&amp;quot;
		   pattern=&amp;quot;%h %l %u %t &amp;amp;quot;%r&amp;amp;quot; %s %b&amp;quot; /&amp;gt;
&amp;lt;/Host&amp;gt;

systemctl start tomcat
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;3. 安装配置 redisrv 实现 session 共享&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;(1)安装配置redisrv
yum -y install redis	
cp /etc/redis.conf&amp;#123;,.bak&amp;#125;
vi /etc/redis.conf
#bind 127.0.0.1 #redis默认只允许本地访问,注释bind 127.0.0.1允许所有的IP访问redis
bind 192.168.6.80 192.168.6.82 #指定可以访问的IP
#protected-mode yes #在redis3.2之后,redis增加了protected-mode,在这个模式下,即使注释掉了bind 127.0.0.1,再访问redisd时候还是报错
protected-mode no
daemonize yes
#daemonize no

(2)拷贝以下三个jar文件至各tomcat节点类库文件目录/usr/share/tomcat/lib -&amp;gt; /usr/share/java/tomcat
~# tree tomcat8-redis-session-manager
tomcat8-redis-session-manager/
├── commons-pool2-2.2.jar
├── jedis-2.5.2.jar
└── tomcat-redis-session-manager-2.0.0.jar

(3)编辑各tomcat节点context.xml文件,添加以下内容配置redis服务
vi /etc/tomcat/context.xml
&amp;lt;Valve className=&amp;quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&amp;quot; /&amp;gt;       
&amp;lt;Manager className=&amp;quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&amp;quot;
host=&amp;quot;192.168.6.86&amp;quot; #redisrv,IP地址
port=&amp;quot;6379&amp;quot;
database=&amp;quot;0&amp;quot;
maxInactiveInterval=&amp;quot;60&amp;quot;/&amp;gt;

启动redis服务,重新启动所有tomcat,启动nginx,刷新nginx页面,两台tomcat页面可以看到sessionid值不变,关闭某台tomcat,nginx中sessionid不变,说明session是共享的.

参考博文
	https://www.cnblogs.com/mrlinfeng/p/6146866.html
&lt;/code&gt;&lt;/pre&gt;
 ]]></description>
        </item>
    </channel>
</rss>
